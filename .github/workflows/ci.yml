name: CI

on: [push, pull_request]

jobs:
  tests-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install Tesseract
        run: choco install -y tesseract
      - name: Install deps
        run: |
          python -m pip install -U pip
          python -m pip install -r requirements.txt
      - name: Fetch tessdata
        shell: pwsh
        run: |
          ./scripts/fetch_tessdata.ps1
          $env:TESSDATA_PREFIX = (Resolve-Path .\tessdata).Path
          echo "TESSDATA_PREFIX=$env:TESSDATA_PREFIX" >> $env:GITHUB_ENV
      - name: Run tests
        env:
          TESSDATA_PREFIX: ${{ env.TESSDATA_PREFIX }}
        run: |
          python -m pytest -q

  tests-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install Tesseract
        run: sudo apt-get update && sudo apt-get install -y tesseract-ocr
      - name: Install deps
        run: |
          python -m pip install -U pip
          python -m pip install -r requirements.txt
      - name: Fetch tessdata (ara, fra)
        run: |
          mkdir -p tessdata
          curl -L https://github.com/tesseract-ocr/tessdata_best/raw/main/ara.traineddata -o tessdata/ara.traineddata
          curl -L https://github.com/tesseract-ocr/tessdata_best/raw/main/fra.traineddata -o tessdata/fra.traineddata
      - name: Run tests
        env:
          TESSDATA_PREFIX: ${{ github.workspace }}/tessdata
        run: python -m pytest -q
